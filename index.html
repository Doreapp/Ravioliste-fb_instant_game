<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="full-screen" content="yes" />
    <meta name="screen-orientation" content="portrait" />
    <meta name="viewport" content="user-scalable=no" />
    <link href="style.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- build:js -->
    <script src="https://connect.facebook.net/en_US/fbinstant.6.2.js"></script>
    <!-- endbuild -->
    <!-- <script src="js/display.js"></script> -->
    <script src="main.js"></script>
    <script type="text/javascript">
        let display = window.Display;

        window.onload = function() {
            $('#context-section, #send-section').hide();

            FBInstant.initializeAsync().then(function() {
                downloadAssets();

                // We can start to load assets
                for (let i in 100) {
                    // When preloading assets, make sure to report the progress
                    FBInstant.setLoadingProgress(i);
                }

                // Now that assets are loaded, call startGameAsync
                FBInstant.startGameAsync().then(onLoadFinished);
            });

            //TODO juste pour les tests hors messenger: 
            //downloadAssets();

        }

        function onLoadFinished() {
            //init();
            //TODO start the game here
            $('#player-photo').attr('src', FBInstant.player.getPhoto());
            $('#player-name').html(FBInstant.player.getName());
        }

        function start() {
            //TODO : hide menu and init
            console.log("start()");
            $('#main-menu').hide();
            $('#canvas-container').show();
            startGame();
        }

        function sendMessage() {
            let player = FBInstant.player.getName();
            let payload = {
                action: 'CUSTOM',
                cta: 'Play!',
                text: {
                    default: player + ' is playing to Ravioliste\' game !',
                    localizations: {
                        en_US: player + ' is playing to Ravioliste\' game !',
                        fr_FR: player + ' est entrain de jouer au jeu de la Ravioliste, rejoignez le !'
                    }
                },
                template: 'play_turn',
                data: {
                    myCustomData: '42'
                },
                strategy: 'IMMEDIATE',
                notification: 'NO_PUSH'
            };

            toDataURL(
                './assets/message-img.png',
                function(dataUrl) {
                    payload.image = dataUrl;
                    // This will post a custom update.
                    // If the game is played in a messenger chat thread,
                    // this will post a message into the thread with the specified image and text message.
                    // When others launch the game from this message,
                    // those game sessions will be able to access the specified blob
                    // of data through FBInstant.getEntryPointData()
                    FBInstant.updateAsync(payload).then(function() {
                        display.success('Message was posted!');
                    }).catch(function(error) {
                        display.error('Message was not posted: ' + error.message);
                    });
                }
            );
        }

        function toDataURL(src, callback) {
            let img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = function() {
                let canvas = document.createElement('CANVAS');
                canvas.height = 533;
                canvas.width = 960;
                canvas.getContext('2d').drawImage(this, 0, 0, 960, 533);
                callback(canvas.toDataURL());
            };
            img.src = src;
        }
    </script>
    <!--
    <section id="test-message">
        <h3>Test sending messages</h3>

        <input type="button" onclick="sendMessage();" value="Send message" />
    </section>-->

    <div id="canvas-container" style="display: none;">
        <canvas id="canvas">Your browser does not support HTML5.</canvas>
    </div>

    <div id="main-menu">
        <section>
            <div id="player-infos">
                <!-- TODO : clean test values (src, name) -->
                <img id="player-photo" class="profile_picture" src="https://scontent-cdg2-1.xx.fbcdn.net/v/t1.0-1/cp0/p74x74/13600195_1136496996414850_1271288971452209263_n.jpg?_nc_cat=110&_nc_sid=dbb9e7&_nc_oc=AQk6V2g084HMgR2fzsWtZ17Y5XxTGQ-LDC5cNNZpKwi9zQ0-smnntG5TBsvhO17Y88slDXkR0y_-pa1KwV_8_UN4&_nc_ht=scontent-cdg2-1.xx&oh=d0ecef07ad07d333cc678ab101e40107&oe=5EFB777D"
                />
                <div id="player-name-container">
                    Antoine
                </div>
                <img class="ravioli-pic" src="assets/lil_ravioli.png" />
            </div>
        </section>
        <section id="logo-container">
            <img src="assets/logo.png" id="img-logo">
            <center>
                <h1 class="title">Ravioliste</h1>
            </center>
        </section>

        <section id="interaction-button">
            <input type="button" onclick="start();" value="JOUER" />
        </section>
    </div>
</body>

</html>