<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="full-screen" content="yes" />
    <meta name="screen-orientation" content="portrait" />
    <meta name="viewport" content="user-scalable=no" />
    <link href="style.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- build:js -->
    <script src="https://connect.facebook.net/en_US/fbinstant.6.2.js"></script>
    <!-- endbuild -->
    <!-- <script src="js/display.js"></script> -->
    <script src="main.js"></script>
    <script type="text/javascript">
        let display = window.Display;

        window.onload = function() {
            $('#context-section, #send-section').hide();

            FBInstant.initializeAsync().then(function() {
                downloadAssets();

                // We can start to load assets
                for (let i in 100) {
                    // When preloading assets, make sure to report the progress
                    FBInstant.setLoadingProgress(i);
                }

                // Now that assets are loaded, call startGameAsync
                FBInstant.startGameAsync().then(onStart);
            });

            //TODO juste pour les tests hors messenger: 
            //downloadAssets();
            //onStart();
        }

        function onStart() {
            init();
            //TODO start the game here
        }

        function sendMessage() {
            let player = FBInstant.player.getName();
            let payload = {
                action: 'CUSTOM',
                cta: 'Play!',
                text: {
                    default: player + ' is playing to Ravioliste\' game !',
                    localizations: {
                        en_US: player + ' is playing to Ravioliste\' game !',
                        fr_FR: player + ' est entrain de jouer au jeu de la Ravioliste, rejoignez le !'
                    }
                },
                template: 'play_turn',
                data: {
                    myCustomData: '42'
                },
                strategy: 'IMMEDIATE',
                notification: 'NO_PUSH'
            };

            toDataURL(
                './assets/message-img.png',
                function(dataUrl) {
                    payload.image = dataUrl;
                    // This will post a custom update.
                    // If the game is played in a messenger chat thread,
                    // this will post a message into the thread with the specified image and text message.
                    // When others launch the game from this message,
                    // those game sessions will be able to access the specified blob
                    // of data through FBInstant.getEntryPointData()
                    FBInstant.updateAsync(payload).then(function() {
                        display.success('Message was posted!');
                    }).catch(function(error) {
                        display.error('Message was not posted: ' + error.message);
                    });
                }
            );
        }

        function toDataURL(src, callback) {
            let img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = function() {
                let canvas = document.createElement('CANVAS');
                canvas.height = 533;
                canvas.width = 960;
                canvas.getContext('2d').drawImage(this, 0, 0, 960, 533);
                callback(canvas.toDataURL());
            };
            img.src = src;
        }
    </script>

    <header id="header">
        <h2>Le jeu de la <b>Ravioliste</b></h2>
    </header>
    <!--
    <section id="test-message">
        <h3>Test sending messages</h3>

        <input type="button" onclick="sendMessage();" value="Send message" />
    </section>-->

    <div id="canvas-container">
        <canvas id="canvas">Your browser does not support HTML5.</canvas>
    </div>

</body>

</html>